<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ChaRulet</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

  </head>
  
  <body>

    <div class="page-header">
      <h1>ChaRulet <small>Proyecto para Sistemas Distribuídos</small></h1>
    </div>
    <div id="nameInput" class="container">
      <div class="row">
        <div class="col-lg-6 col-lg-offset-3">
          <form id='insertaNick'>
            <div id='grupoNick' class="form-group">
              <div class="input-group">
                <input id='nombreUsuario' type="text" class="form-control" placeholder='Ingrese su nombre de usuario'>
                <span class="input-group-btn">
                  <button class="btn btn-default" type="button"><span class='glyphicon glyphicon-log-in'></span> Entrar</button>
                </span>
              </div>
            </div>
          </form>
          <p id="errorNick"> </p>
        </div>
      </div>
    </div>

    <div id="chatRoom" class="container row">
      <h1>Sala de Chat</h1>
      
      <div class="col-lg-4">
        <div class="thumbnail">
          <img src="img/cara1.jpg">
          <h4 id="hisName">Otro Usuario</h4>
        </div>
        <div class="thumbnail">
          <img src="img/cara2.jpg">
          <h4 id="yourName">Usted</h4>
        </div>
      </div>
      <div class="jumbotron col-lg-8">
        <button type="button" class="btn btn-default" id='bSiguiente'>Siguiente usuario</button>
        <div id="messagePanel" class="panel panel-default ">
          <div class="panel-body" id='chatPanel'>
            
          </div>
        </div>
        <form id='enviaMensaje'>
          <div class="form-group">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Escriba su Mensaje" id="cuadroMensaje">
                <span class="input-group-btn">
                  <button id="enviarMensaje" class="btn btn-default" type="button submit">Enviar</button>
                </span>
            </div>
          </div>
        </form>
          
        
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      $(function(){

        $('#chatRoom').hide();        

        var socket = io.connect();

        var $formaID = $('#insertaNick');

        var $entraNick = $('#nombreUsuario');

        var $chat = $('#chatPanel');

        var $enviaMensaje = $('#enviaMensaje');

        var $elMensaje = $('#cuadroMensaje');


        var nickCompanero = null;

        $formaID.submit(function(e){
          e.preventDefault();

          socket.emit('entrar', $entraNick.val(), function(data){
            if(data){
              $('#nameInput').hide();
              $('#chatRoom').show();
              document.getElementById('cuadroMensaje').disabled = true;              
            }          
            else{
              $('#grupoNick').addClass("has-error");
              $('#errorNick').html('Intenta con otro nick');
            }
          });
        });
        //Recibiendo mis credenciales
        socket.on('sesion', function(data){
          var token = data.token;
          var IDSesion = data.sessionID;
          //console.log('El ID de esta sesión es ' + IDSesion);
        });

        //Función para buscar otro compañero
        document.getElementById('bSiguiente').onclick = function(){          
          socket.emit('siguiente', nickCompanero ,function(data){
              document.getElementById('cuadroMensaje').disabled = true;
              if (data) {
                console.log('Esperando conexión');
                document.getElementById('cuadroMensaje').disabled = false;
              }else{
                console.log('No hay gente libre');
              };
          });
        };

        //Cuando me pidan suscripción
        socket.on('suscribete', function(data){
          //Debo guardar los datos de mi compañero          
          nickCompanero = data;
          document.getElementById('cuadroMensaje').disabled = false;
          console.log('Suscrito con '+ nickCompanero);
        });

        //Cuando me pidan desconexion
        socket.on('desuscribir', function(data){
          document.getElementById('cuadroMensaje').disabled = true;
          $chat.append('Su compañero buscó a otro con quien hablar <br/>');
          nickCompanero = null;
        });

        //Cuando reciba un mensaje
        socket.on('mensaje', function(data){
          //Simplemente lo escribo
          $chat.append(data.nick+ ' dice: '+ data.mensaje+"<br/>");
        });

        //Cuando envío un mensaje
        $enviaMensaje.submit(function(e){
          e.preventDefault();
          $chat.append('Usted dice: '+ $elMensaje.val() +"<br/>");
          var datos = {
              //Le digo cual es el mensaje
              mensaje: $elMensaje.val(),
              //y a quién se lo quiero enviar
              destino: nickCompanero
            };
          socket.emit('mensaje', datos);
          $elMensaje.val('')
        });
      });
      
    </script>
    
  </body>
  
</html>